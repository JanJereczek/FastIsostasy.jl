<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Parameter inversion · FastIsostasy.jl</title><meta name="title" content="Parameter inversion · FastIsostasy.jl"/><meta property="og:title" content="Parameter inversion · FastIsostasy.jl"/><meta property="twitter:title" content="Parameter inversion · FastIsostasy.jl"/><meta name="description" content="Documentation for FastIsostasy.jl."/><meta property="og:description" content="Documentation for FastIsostasy.jl."/><meta property="twitter:description" content="Documentation for FastIsostasy.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="https://fonts.googleapis.com/css?family=Montserrat|Source+Code+Pro&amp;display=swap" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="FastIsostasy.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">FastIsostasy.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">FastIsostasy.jl</a></li><li><a class="tocitem" href="../../introGIA/">Quick intro to GIA</a></li><li><a class="tocitem" href="../tutorial/">Tutorial</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../glacialcycle/">Glacial cycle</a></li><li class="is-active"><a class="tocitem" href>Parameter inversion</a></li></ul></li><li><span class="tocitem">References</span><ul><li><a class="tocitem" href="../../APIref/">API reference</a></li><li><a class="tocitem" href="../../fortran/">Fortran version</a></li><li><a class="tocitem" href="../../references/">Bibliography</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Parameter inversion</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Parameter inversion</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JanJereczek/FastIsostasy.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JanJereczek/FastIsostasy.jl/blob/main/docs/src/examples/inversion.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Parameter-inversion"><a class="docs-heading-anchor" href="#Parameter-inversion">Parameter inversion</a><a id="Parameter-inversion-1"></a><a class="docs-heading-anchor-permalink" href="#Parameter-inversion" title="Permalink"></a></h1><p>Assume a dynamical system <span>$f$</span> generates an output <span>$y$</span> based on its input <span>$x$</span> and on a set of parameters <span>$\theta$</span>. The goal of a parameter inversion is to estimate the parameters <span>$\theta$</span> that best fit the data <span>$\hat{y}$</span> with respect to an error metric <span>$\Psi$</span>, i.e. to solve the following optimization problem:</p><p class="math-container">\[\begin{aligned}
y &amp;=&amp; f(x, \theta) \\
\hat{\theta} &amp;=&amp; \arg\min_{\theta} \Psi(\hat{y} - y)
\end{aligned}\]</p><p>Since FastIsostasy relies on simplifications of the full GIA problem, applying such inversion can be useful to tune the model parameters (upper-mantle viscosity field, lithospheric thickness... etc.) such that the output <span>$y$</span> (typically the displacement) matches the data <span>$\hat{y}$</span> (typically obtained from observations or from a 3D GIA model). There are many ways of solving this problem, among which the use of Kalman filtering techniques. FastIsostasy.jl provides convenience functions for the latter by wrapping the functionalities of EnsembleKalmanProcesses.jl in an external routine that is automatically loaded when <code>using EnsembleKalmanProcesses</code>.</p><p>We demonstrate the tuning of the effective viscosity in a region that is being forced by a circular ice load. We emphasise that the highlighted tools provided by FastIsostasy are not limited to this case. As it will be made clear throughout the example, the user merely needs to define their own <a href="../../APIref/#FastIsostasy.ParameterReduction"><code>ParameterReduction</code></a> and the associated behaviours of <a href="../../APIref/#FastIsostasy.reconstruct!"><code>reconstruct!</code></a> and <a href="../../APIref/#FastIsostasy.extract_output"><code>extract_output</code></a> to adapt the inversion procedure to their needs (e.g. tune lithospheric thickness throughout the whole domain).</p><div class="admonition is-info"><header class="admonition-header">Resolution</header><div class="admonition-body"><p>We perform the following analysis on a low-resolution grid. High resolutions (ca. <code>Omega.Nx = Omega.Ny &gt; 200</code>) are difficult to achieve since the underlying unscented Kalman filter requires many simulations. This is however typically not a problem, since the parametric fields (here the viscosity) are smooth and can be downsampled without significant loss of information.</p></div></div><p>We first load the necessary packages, initialize the <a href="../../APIref/#FastIsostasy.ComputationDomain"><code>ComputationDomain</code></a> and assign laterally-variable viscosity profiles to a <a href="../../APIref/#FastIsostasy.LayeredEarth"><code>LayeredEarth</code></a> by loading the fields estimated in <a href="../../references/#wiens-seismic-2022">Wiens <em>et al.</em> (2022)</a>:</p><pre><code class="language-julia hljs">using CairoMakie
using Distributions
using EnsembleKalmanProcesses
using EnsembleKalmanProcesses.ParameterDistributions
using FastIsostasy
using LinearAlgebra

Omega = ComputationDomain(3000e3, 5)
c = PhysicalConstants()
lb = [100e3, 200e3, 300e3]
_, eta, eta_itp = load_dataset(&quot;Wiens2022&quot;)
loglv = cat([eta_itp.(Omega.X, Omega.Y, z) for z in lb]..., dims = 3)
lv = 10 .^ loglv
p = LayeredEarth(Omega, layer_boundaries = lb, layer_viscosities = lv)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">LayeredEarth{Float64, Matrix{Float64}}([2.8882687455337736e20 8.390101128670159e20 … 7.11238760892716e20 2.548861742533004e20; 4.9859163933404686e20 2.8563286881831748e20 … 6.124735899366491e20 2.145763590353581e20; … ; 7.842816921212305e20 8.112869530785191e20 … 7.118861791640621e20 6.685915619309133e20; 5.342589933662746e20 7.656245072962721e20 … 3.080940856185763e20 3.5344830301378085e20], [100000.0 100000.0 … 100000.0 100000.0; 100000.0 100000.0 … 100000.0 100000.0; … ; 100000.0 100000.0 … 100000.0 100000.0; 100000.0 100000.0 … 100000.0 100000.0], [5.967881944444444e24 5.967881944444444e24 … 5.967881944444444e24 5.967881944444444e24; 5.967881944444444e24 5.967881944444444e24 … 5.967881944444444e24 5.967881944444444e24; … ; 5.967881944444444e24 5.967881944444444e24 … 5.967881944444444e24 5.967881944444444e24; 5.967881944444444e24 5.967881944444444e24 … 5.967881944444444e24 5.967881944444444e24], 0.28, 0.28, [2.6981748e10 2.6981748e10 … 2.6981748e10 2.6981748e10; 2.6981748e10 2.6981748e10 … 2.6981748e10 2.6981748e10; … ; 2.6981748e10 2.6981748e10 … 2.6981748e10 2.6981748e10; 2.6981748e10 2.6981748e10 … 2.6981748e10 2.6981748e10], 6.6e10, 2.578125e10, 3400.0, 3200.0)</code></pre><p>To make this problem more exciting, we place the center of the ice load to <span>$(-1000, -1000) \: \mathrm{km}$</span> where the viscosity field displays a less uniform structure. For the sake of simplicity, the data to fit is obtained from a FastIsostasy simulation with the ground-truth viscosity field.</p><pre><code class="language-julia hljs">R, H = 1000e3, 1e3
Hcylinder = uniform_ice_cylinder(Omega, R, H, center = [-1000e3, -1000e3])
Hice = [zeros(Omega.Nx, Omega.Ny), Hcylinder, Hcylinder]
t_out = collect(1e3:1e3:2e3)
pushfirst!(t_out, t_out[1]-1e-8)
t_Hice = copy(t_out)

true_viscosity = copy(p.effective_viscosity)
fip = FastIsoProblem(Omega, c, p, t_out, t_Hice, Hice, output = &quot;sparse&quot;)
solve!(fip)</code></pre><p>Assuming the result of this simulation to be the ground truth <span>$\hat{y}$</span>, we can now build an <a href="../../APIref/#FastIsostasy.InversionData"><code>InversionData</code></a> object that will be passed to an <a href="../../APIref/#FastIsostasy.InversionProblem"><code>InversionProblem</code></a>. The <a href="../../APIref/#FastIsostasy.InversionData"><code>InversionData</code></a> object contains the time series of the input field <code>X = Hice</code> and the output field <code>Y = extract_fip(fip)</code> (here the displacement field). Furthermore, we define an <a href="../../APIref/#FastIsostasy.InversionConfig"><code>InversionConfig</code></a> that uses the unscented Kalman filter as introduced in <a href="../../references/#huang-improve-2021">Huang and Huang (Feb 2021)</a>.</p><pre><code class="language-julia hljs">X = Hice
mask3D = cat([x .&gt; 0 for x in X]..., dims = 3)
mask = reduce(|, mask3D, dims = 3)[:, :, 1]     # Only tune viscosity where there is ice.

t_inv = t_out[end:end]                          # Only use last time step for inversion.
extract_last_viscous_displacement(fip) = fip.out.u[end:end]
extract_fip = extract_last_viscous_displacement
Y = extract_fip(fip)

data = InversionData(t_inv, length(t_inv), X, Y, mask, count(mask))
config = InversionConfig(Unscented, N_iter = 15, scale_obscov = 10.0)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">InversionConfig{Float64}(EnsembleKalmanProcesses.Unscented, 15, 1.0, 1, 100, 10.0)</code></pre><p>Before finalising the inversion, we need to specify a <a href="../../APIref/#FastIsostasy.ParameterReduction"><code>ParameterReduction</code></a>, which allows a multiple dispatch of <a href="../../APIref/#FastIsostasy.reconstruct!"><code>reconstruct!</code></a>, <a href="../../APIref/#FastIsostasy.extract_output"><code>extract_output</code></a> and (optionally) <a href="../../APIref/#FastIsostasy.print_inversion_evolution"><code>print_inversion_evolution</code></a>. This allows the inversion procedure to update the parameters, extract the relevant output and (optionally) print out meaningful information over the iterations of the inversion procedure. In this example, we define a <code>ViscosityRegion</code> that reduces the number of parameters to the number of grid points in the mask.</p><pre><code class="language-julia hljs">struct ViscosityRegion{T&lt;:AbstractFloat} &lt;: ParameterReduction{T}
    mask::BitMatrix
    nparams::Int
end

function FastIsostasy.reconstruct!(fip, params, reduction::ViscosityRegion)
    fip.p.effective_viscosity[reduction.mask] .= 10 .^ params
end

function FastIsostasy.extract_output(fip, reduction::ViscosityRegion, data::InversionData)
    return extract_fip(fip)[1][reduction.mask]
end

function FastIsostasy.print_inversion_evolution(paraminv, n, ϕ_n, reduction::ViscosityRegion)
    err_n = paraminv.error[n]
    cov_n = paraminv.ukiobj.process.uu_cov[n]

    println(&quot;-----------------------------------------------------&quot;)
    println(&quot;Inversion being performed with $(typeof(reduction)) as a parameter reduction&quot;)
    @show size(ϕ_n), n, err_n, norm(cov_n)
    println(&quot;Mean tuned log10-viscosity: $(round(mean(ϕ_n), digits = 3))&quot;)
    println(&quot;Extrema of tuned log10-viscosity: $(extrema(ϕ_n))&quot;)
    return nothing
end

reduction = ViscosityRegion{Float64}(mask, count(mask))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Main.ViscosityRegion{Float64}(Bool[0 0 … 0 0; 0 0 … 0 0; … ; 0 0 … 0 0; 0 0 … 0 0], 86)</code></pre><p>We can now proceed to the definition of the <a href="../../APIref/#FastIsostasy.InversionProblem"><code>InversionProblem</code></a> with a prior distribution that is a Gaussian with mean <span>$20.5$</span>, variance <span>$0.5$</span> and bounds <span>$[19.0, 22.0]$</span>. We then check the initialisation of the inversion problem by reconstructing the field with the prior parameters:</p><pre><code class="language-julia hljs">priors = combine_distributions([constrained_gaussian( &quot;p_$(i)&quot;,
    20.5, 0.5, 19.0, 22.0) for i in 1:reduction.nparams])
paraminv = inversion_problem(deepcopy(fip), config, data, reduction, priors)

params = fill(20.5, count(mask))
reconstruct!(paraminv.fip, params, reduction)
function plot_viscfields(paraminv)
    cmap = cgrad(:jet, rev = true)
    crange = (19.5, 21.5)
    fig = Figure(size = (1800, 1000), fontsize = 40)
    axs = [Axis(fig[1,i], aspect = DataAspect()) for i in 1:2]
    [hidedecorations!(ax) for ax in axs]
    heatmap!(axs[1], log10.(true_viscosity), colormap = cmap, colorrange = crange)
    heatmap!(axs[2], log10.(paraminv.fip.p.effective_viscosity),
        colormap = cmap, colorrange = crange)
    Colorbar(fig[2, :], vertical = false, colormap = cmap, colorrange = crange,
        width = Relative(0.5))
    return fig
end
fig1 = plot_viscfields(paraminv)</code></pre><img src="c2ca37e9.png" alt="Example block output"/><p>Finally, we solve the inversion problem and visualise the results.</p><pre><code class="language-julia hljs">solve!(paraminv)
fig2 = plot_viscfields(paraminv)</code></pre><img src="1928db9b.png" alt="Example block output"/></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../glacialcycle/">« Glacial cycle</a><a class="docs-footer-nextpage" href="../../APIref/">API reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Saturday 17 August 2024 13:16">Saturday 17 August 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
