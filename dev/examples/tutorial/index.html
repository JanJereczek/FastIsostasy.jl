<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tutorial · FastIsostasy.jl</title><meta name="title" content="Tutorial · FastIsostasy.jl"/><meta property="og:title" content="Tutorial · FastIsostasy.jl"/><meta property="twitter:title" content="Tutorial · FastIsostasy.jl"/><meta name="description" content="Documentation for FastIsostasy.jl."/><meta property="og:description" content="Documentation for FastIsostasy.jl."/><meta property="twitter:description" content="Documentation for FastIsostasy.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="https://fonts.googleapis.com/css?family=Montserrat|Source+Code+Pro&amp;display=swap" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="FastIsostasy.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">FastIsostasy.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">FastIsostasy.jl</a></li><li><a class="tocitem" href="../../introGIA/">Quick intro to GIA</a></li><li class="is-active"><a class="tocitem" href>Tutorial</a><ul class="internal"><li><a class="tocitem" href="#3D-2D-Earth"><span>3D ➡ 2D Earth</span></a></li><li><a class="tocitem" href="#Simple-load-and-geometry"><span>Simple load and geometry</span></a></li><li><a class="tocitem" href="#GPU-support"><span>GPU support</span></a></li><li><a class="tocitem" href="#Make-your-own-time-loop"><span>Make your own time loop</span></a></li><li><a class="tocitem" href="#Using-different-backends"><span>Using different backends</span></a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../glacialcycle/">Glacial cycle</a></li></ul></li><li><span class="tocitem">References</span><ul><li><a class="tocitem" href="../../APIref/">API reference</a></li><li><a class="tocitem" href="../../fortran/">Fortran version</a></li><li><a class="tocitem" href="../../references/">Bibliography</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Tutorial</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tutorial</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JanJereczek/FastIsostasy.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JanJereczek/FastIsostasy.jl/blob/main/docs/src/examples/tutorial.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Tutorial"><a class="docs-heading-anchor" href="#Tutorial">Tutorial</a><a id="Tutorial-1"></a><a class="docs-heading-anchor-permalink" href="#Tutorial" title="Permalink"></a></h1><p>In this section, we will present some examples with idealised loads and solid-Earth parameters. This should give the user a basic understanding of FastIsostasy&#39;s basic functions.</p><h2 id="3D-2D-Earth"><a class="docs-heading-anchor" href="#3D-2D-Earth">3D ➡ 2D Earth</a><a id="3D-2D-Earth-1"></a><a class="docs-heading-anchor-permalink" href="#3D-2D-Earth" title="Permalink"></a></h2><p>FastIsostasy relies on a (polar) stereographic projection. Let&#39;s first create <code>Omega::ComputationDomain</code> and visualise how this relates to a domain on a spherical Earth:</p><pre><code class="language-julia hljs">using CairoMakie, FastIsostasy

W = 3000e3      # (m) half-width of the domain Wx = Wy
n = 7           # implies an Nx x Ny grid with Nx = Ny = 2^n = 128.
Omega = ComputationDomain(W, n)
fig = Figure(size = (1600, 800), fontsize = 24)
axs = [Axis3(fig[1, j], title = [&quot;Original grid&quot;, &quot;Projected grid&quot;][j]) for j in 1:2]
wireframe!(axs[1], Omega.X .* Omega.K, Omega.Y .* Omega.K,
    Omega.R .* cos.(deg2rad.(Omega.Lat)), color = :gray10, linewidth = 0.1)
wireframe!(axs[2], Omega.X .* Omega.K, Omega.Y .* Omega.K,
    Omega.null, color = :gray10, linewidth = 0.1)
for ax in axs
    zlims!(ax, (0, 5e6))
    hidedecorations!(ax)
    hidespines!(ax)
end
fig</code></pre><img src="cdfa2f16.png" alt="Example block output"/><p>The distortion factor <code>Omega.K</code> is not only accessible but also accounted for in all the computations. The projection allows to treat the radially-layered, onion-like structure of the solid Earth as a superposition of horizontal layers. Furthermore, FastIsostasy reduces this 3D problem into a 2D problem by collapsing the depth dimension, mainly through the computation of an effective viscosity field that accounts for the superposition of layers with different viscosities. The user is required to provide the 3D information, which will then be used under the hood to compute the effective viscosity. This tutorial shows such an example.</p><p>We want to render a situation similar to the one depicted below:</p><p><img src="../../assets/sketch_nlayer_model.png" alt="Schematic representation of the three-layer set-up."/></p><p>Initializing a <a href="../../APIref/#FastIsostasy.LayeredEarth"><code>LayeredEarth</code></a> with parameters corresponding to this situation automatically computes the conversion from a 3D to a 2D problem. Since we will compare our solution to an analytical one of a flat Earth, we exceptionally switch off the distortion correction. This can be simply executed by running:</p><pre><code class="language- hljs">Omega = ComputationDomain(W, n, correct_distortion = false)
c = PhysicalConstants(rho_litho = 0.0)
lv = [1e19, 1e21]       # viscosity layers (Pa s)
lb = [88e3, 400e3]      # depth of layer boundaries (m)
p = LayeredEarth(Omega, layer_viscosities = lv, layer_boundaries = lb)
extrema(p.effective_viscosity)</code></pre><p>As expected, the effective viscosity is a homogeneous field. It corresponds to a nonlinear mean of the layered values provided by the user. Note that we have set <span>$\rho_{litho} = 0$</span> to prevent the lithosphere from contributing to the hydrostatic, upward force. This is made to comply with the later computed analytical solution, which assumes a purely elastic lithosphere that does not generate a hydrostatic upward force when displaced. In reality, this is arguably wrong and the default choice <code>c = PhysicalConstants()</code> therefore uses <span>$\rho_{litho} = 2600 \, \mathrm{kg \, m^{-3}}$</span>.</p><p>The next section shows how to use the now obtained <code>p::LayeredEarth</code> for actual GIA computation.</p><h2 id="Simple-load-and-geometry"><a class="docs-heading-anchor" href="#Simple-load-and-geometry">Simple load and geometry</a><a id="Simple-load-and-geometry-1"></a><a class="docs-heading-anchor-permalink" href="#Simple-load-and-geometry" title="Permalink"></a></h2><p>We now apply a constant load, here a cylinder of ice with radius <span>$R = 1000 \, \mathrm{km}$</span> and thickness <span>$H = 1 \, \mathrm{km}$</span>, over <code>Omega::ComputationDomain</code> introduced in <a href="../../APIref/#FastIsostasy.LayeredEarth"><code>LayeredEarth</code></a>. To formulate the problem conviniently, we use <a href="../../APIref/#FastIsostasy.FastIsoProblem"><code>FastIsoProblem</code></a>, a struct containing the variables and options that are necessary to perform the integration over time. We can then simply apply <code>solve!(fip::FastIsoProblem)</code> to perform the integration of the ODE. Under the hood, the ODE is obtained from the PDE by applying a Fourier collocation scheme contained in <a href="../../APIref/#FastIsostasy.lv_elva!"><code>lv_elva!</code></a>. The integration is performed according to <code>FastIsoProblem.diffeq::NamedTuple</code>, which contains the algorithm and optionally tolerances, maximum iteration number... etc.</p><pre><code class="language- hljs">R = 1000e3                  # ice disc radius (m)
H = 1e3                     # ice disc thickness (m)
Hcylinder = uniform_ice_cylinder(Omega, R, H)
Hice = [zeros(Omega.Nx, Omega.Ny), Hcylinder, Hcylinder]

t_out = years2seconds.([0.0, 200.0, 600.0, 2000.0, 5000.0, 10_000.0, 50_000.0])
εt = 1e-8
pushfirst!(t_out, -εt)
t_Hice = [-εt, 0.0, t_out[end]]
fip = FastIsoProblem(Omega, c, p, t_out, t_Hice, Hice, output = &quot;sparse&quot;)
solve!(fip)

function plot3D(fip, k_idx)
    X, Y, out = Array(fip.Omega.X), Array(fip.Omega.Y), fip.out
    zl = extrema(out.ue[end] + out.u[end])
    fig = Figure(fontsize = 10)
    for j in eachindex(k_idx)
        ax = Axis3(fig[1, j])
        u_tot = out.ue[k_idx[j]] + out.u[k_idx[j]]
        surface!(ax, X, Y, u_tot, colormap = :cool)
        wireframe!(ax, X, Y, u_tot, color = :black, linewidth = 0.1)
        zlims!(ax, zl)
    end
    return fig
end
fig = plot3D(fip, [lastindex(t_out) ÷ 2, lastindex(t_out)])</code></pre><p>... and here goes the total displacement at <span>$t = 50 \, \mathrm{kyr}$</span>. You can now access the elastic and viscous displacement at time <code>t_out[k]</code> by respectively calling <code>fip.out.ue[k]</code> and <code>fip.out.u[k]</code>. For the present case, the latter can be compared to an analytic solution that is known for this particular case. Let&#39;s look at the accuracy of our numerical scheme over time by running following plotting commands:</p><pre><code class="language- hljs">fig = Figure()
ax = Axis(fig[1, 1])
cmap = cgrad(:jet, length(t_out), categorical = true)
ii, jj = Omega.Mx:Omega.Nx, Omega.My
x = Omega.X[ii, jj]
r = Omega.R[ii, jj]

for k in eachindex(t_out)
    analytic_solution_r(r) = analytic_solution(r, t_out[k], c, p, H, R)
    u_analytic = analytic_solution_r.(r)
    u_numeric = fip.out.u[k][ii, jj]
    lines!(ax, x, u_analytic, color = cmap[k], linewidth = 5,
        label = L&quot;$u_{ana}(t = %$(round(seconds2years(t_out[k]))) \, \mathrm{yr})$&quot;)
    lines!(ax, x, u_numeric, color = cmap[k], linewidth = 5, linestyle = :dash,
        label = L&quot;$u_{num}(t = %$(round(seconds2years(t_out[k]))) \, \mathrm{yr})$&quot;)
end
axislegend(ax, position = :rb, nbanks = 2, patchsize = (50.0f0, 20.0f0))
fig</code></pre><h2 id="GPU-support"><a class="docs-heading-anchor" href="#GPU-support">GPU support</a><a id="GPU-support-1"></a><a class="docs-heading-anchor-permalink" href="#GPU-support" title="Permalink"></a></h2><p>For about <span>$n \geq 7$</span>, the present example can be computed even faster by using GPU parallelism. It could not represent less work from the user&#39;s perspective, as it boils down to calling <a href="../../APIref/#FastIsostasy.ComputationDomain"><code>ComputationDomain</code></a> with an extra keyword argument:</p><pre><code class="language- hljs">Omega = ComputationDomain(W, n, use_cuda = true);
nothing #hide</code></pre><p>We then pass <code>Omega</code> to a <code>LayeredEarth</code> and a <code>FastIsoProblem</code>, which we solve: that&#39;s it! For postprocessing, consider using <a href="../../APIref/#FastIsostasy.reinit_structs_cpu"><code>reinit_structs_cpu</code></a>.</p><div class="admonition is-info"><header class="admonition-header">Only CUDA supported!</header><div class="admonition-body"><p>For now only Nvidia GPUs are supported and there is no plan of extending this compatibility at this point.</p></div></div><h2 id="Make-your-own-time-loop"><a class="docs-heading-anchor" href="#Make-your-own-time-loop">Make your own time loop</a><a id="Make-your-own-time-loop-1"></a><a class="docs-heading-anchor-permalink" href="#Make-your-own-time-loop" title="Permalink"></a></h2><p>As any high-level function, <a href="../../APIref/#FastIsostasy.solve!-Tuple{FastIsoProblem}"><code>solve!</code></a> has some limitations. An ice-sheet modeller typically wants to embed FastIsostasy within a time-stepping loop. This can be easily done by getting familiar with some intermediate-level functions like <a href="../../APIref/#FastIsostasy.init"><code>init</code></a>, <a href="../../APIref/#FastIsostasy.step!"><code>step!</code></a> and <a href="../../APIref/#FastIsostasy.write_out!"><code>write_out!</code></a>:</p><pre><code class="language- hljs">Omega = ComputationDomain(3000e3, n)
p = LayeredEarth(Omega)
fip = FastIsoProblem(Omega, c, p, t_out, t_Hice, Hice, output = &quot;sparse&quot;)

update_diagnostics!(fip.now.dudt, fip.now.u, fip, 0.0)
write_out!(fip.out, fip.now, 1)
ode = init(fip)
@inbounds for k in eachindex(fip.out.t)[2:end]
    step!(fip, ode, (fip.out.t[k-1], fip.out.t[k]))
    write_out!(fip.out, fip.now, k)
end
fig = plot3D(fip, [lastindex(t_out) ÷ 2, lastindex(t_out)])</code></pre><div class="admonition is-info"><header class="admonition-header">Coupling to julia Ice-Sheet model</header><div class="admonition-body"><p>In case your Ice-Sheet model is programmed in julia, we highly recommend performing the coupling within the function updating the derivatives and let <code>OrdinaryDiffEq.jl</code> handle the rest.</p></div></div><div class="admonition is-warning"><header class="admonition-header">GPU not supported</header><div class="admonition-body"><p><a href="../../APIref/#FastIsostasy.step!"><code>step!</code></a> does not support GPU computation so far. Make sure your model is initialized on CPU.</p></div></div><h2 id="Using-different-backends"><a class="docs-heading-anchor" href="#Using-different-backends">Using different backends</a><a id="Using-different-backends-1"></a><a class="docs-heading-anchor-permalink" href="#Using-different-backends" title="Permalink"></a></h2><p>ELRA is a GIA model that is commonly used in ice-sheet modelling. For the vast majority of applications, it is less accurate than LV-ELVA without providing any significant speed up. However, it can be used by specifying adequate options:</p><pre><code class="language- hljs">p = LayeredEarth(Omega, tau = years2seconds(3e3))
opts = SolverOptions(deformation_model = :elra)
fip = FastIsoProblem(Omega, c, p, t_out, t_Hice, Hice, opts = opts, output = &quot;sparse&quot;)
solve!(fip)
fig = plot3D(fip, [lastindex(t_out) ÷ 2, lastindex(t_out)])</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../introGIA/">« Quick intro to GIA</a><a class="docs-footer-nextpage" href="../glacialcycle/">Glacial cycle »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Thursday 1 August 2024 08:49">Thursday 1 August 2024</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
